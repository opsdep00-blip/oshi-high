# Environment Variables Guide

## Overview

OSHI-HIGH uses a two-tier environment configuration:

1. **Local Development (.env.local)**: For local testing with mocked services
2. **GCP Secret Manager**: For production secrets (never committed to git)

## Environment Variable Categories

### Common (Development & Production)

| Variable | Purpose | Example | Note |
|----------|---------|---------|------|
| `NEXTAUTH_SECRET` | NextAuth encryption key | 32-char random string | Generate: `openssl rand -base64 32` |
| `NEXTAUTH_URL` | NextAuth callback URL | `http://localhost:3000` | Set to production URL in Cloud Run |
| `DATABASE_URL` | PostgreSQL connection string | `postgresql://user:pass@host:5432/db` | Cloud SQL in production |

### Local Development Only

| Variable | Purpose | Value | When to Use |
|----------|---------|-------|------------|
| `ENABLE_SMS_MOCK` | Mock SMS sending (Twilio/SendGrid) | `"true"` | Always true in `.env.local` |
| `SMS_PROVIDER` | Provider name when mock is false | `twilio` or `firebase` | For staging/prod; keep `twilio` locally |
| `TWITTER_CLIENT_ID` | Twitter OAuth credentials | From Twitter Developer Portal | Optional for local OAuth testing |
| `TWITTER_CLIENT_SECRET` | Twitter OAuth credentials | From Twitter Developer Portal | Optional for local OAuth testing |

### Production Only (GCP Secret Manager)

| Variable | Purpose | Managed By | Reference |
|----------|---------|------------|-----------|
| `SMS_PROVIDER` | Provider name when mock is false | Secret Manager | `twilio` (default) or `firebase` |
| `TWILIO_ACCOUNT_SID` | Twilio account SID | Secret Manager | Required if `SMS_PROVIDER=twilio` |
| `TWILIO_AUTH_TOKEN` | Twilio auth token | Secret Manager | Required if `SMS_PROVIDER=twilio` |
| `TWILIO_MESSAGING_SERVICE_SID` | Twilio Messaging Service SID | Secret Manager | Preferred if `SMS_PROVIDER=twilio` |
| `TWILIO_FROM_NUMBER` | Twilio From phone number | Secret Manager | Use if Messaging Service SID is not set |
| `FIREBASE_PROJECT_ID` | GCP Firebase Project ID | GCP Secret Manager | Used for SMS via Twilio/SendGrid |
| `FIREBASE_CLIENT_EMAIL` | GCP Service Account Email | GCP Secret Manager | For Cloud Vision API, etc. |
| `FIREBASE_PRIVATE_KEY` | GCP Service Account Private Key | GCP Secret Manager | For authenticated GCP API calls |

## Setup Instructions

### 1. Local Development Setup

```bash
# Copy the example file
cp .env.local.example .env.local

# Generate NEXTAUTH_SECRET
openssl rand -base64 32

# Fill in .env.local with generated values
nano .env.local
```

**Critical**: 
- Set `ENABLE_SMS_MOCK="true"` for local testing
- Keep `.env.local` out of git (already in `.gitignore`)
- Never commit real secrets

### 2. Production Setup (GCP Cloud Run)

#### Step 1: Create GCP Secrets

```bash
# Login to GCP
gcloud auth login
gcloud config set project oshi-high

# Create secrets (values from GCP Service Account)
echo -n "your-project-id" | gcloud secrets create FIREBASE_PROJECT_ID --data-file=-
echo -n "your-service-account@project.iam.gserviceaccount.com" | gcloud secrets create FIREBASE_CLIENT_EMAIL --data-file=-
echo -n "$(cat /path/to/service-account-key.json | jq -r .private_key)" | gcloud secrets create FIREBASE_PRIVATE_KEY --data-file=-

# Generate NEXTAUTH_SECRET
openssl rand -base64 32 | gcloud secrets create NEXTAUTH_SECRET --data-file=-

# Set production DATABASE_URL (Cloud SQL)
gcloud secrets create DATABASE_URL --data-file=- << 'EOF'
postgresql://oshi_high_user:PASSWORD@cloudsql-proxy.c.oshi-high.internal:5432/oshi_high_prod
EOF
```

#### Step 2: Grant Cloud Run Access to Secrets

```bash
# Get Cloud Run service account
SERVICE_ACCOUNT=$(gcloud run services describe oshi-high-web --region asia-northeast1 --format='value(spec.template.spec.serviceAccountName)')

# Grant Secret Accessor role
for SECRET in FIREBASE_PROJECT_ID FIREBASE_CLIENT_EMAIL FIREBASE_PRIVATE_KEY NEXTAUTH_SECRET DATABASE_URL; do
  gcloud secrets add-iam-policy-binding $SECRET \
    --member="serviceAccount:$SERVICE_ACCOUNT" \
    --role="roles/secretmanager.secretAccessor"
done
```

#### Step 3: Update Cloud Run Deployment

In `clouddeploy.yaml` or gcloud CLI:

```yaml
spec:
  template:
    spec:
      containers:
        - image: gcr.io/oshi-high/oshi-high-web:latest
          env:
            - name: NEXTAUTH_SECRET
              valueFrom:
                secretKeyRef:
                  name: NEXTAUTH_SECRET
                  key: latest
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: DATABASE_URL
                  key: latest
            - name: FIREBASE_PROJECT_ID
              valueFrom:
                secretKeyRef:
                  name: FIREBASE_PROJECT_ID
                  key: latest
            - name: FIREBASE_CLIENT_EMAIL
              valueFrom:
                secretKeyRef:
                  name: FIREBASE_CLIENT_EMAIL
                  key: latest
            - name: FIREBASE_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: FIREBASE_PRIVATE_KEY
                  key: latest
            - name: ENABLE_SMS_MOCK
              value: "false"
```

Or with gcloud:

```bash
gcloud run deploy oshi-high-web \
  --image gcr.io/oshi-high/oshi-high-web:latest \
  --region asia-northeast1 \
  --set-env-vars ENABLE_SMS_MOCK=false \
  --update-secrets NEXTAUTH_SECRET=NEXTAUTH_SECRET:latest \
  --update-secrets DATABASE_URL=DATABASE_URL:latest \
  --update-secrets FIREBASE_PROJECT_ID=FIREBASE_PROJECT_ID:latest \
  --update-secrets FIREBASE_CLIENT_EMAIL=FIREBASE_CLIENT_EMAIL:latest \
  --update-secrets FIREBASE_PRIVATE_KEY=FIREBASE_PRIVATE_KEY:latest
```

## Security Best Practices

### ✅ DO:
- Generate strong `NEXTAUTH_SECRET` with `openssl rand -base64 32`
- Store all secrets in GCP Secret Manager for production
- Rotate secrets regularly (at least quarterly)
- Use separate secrets for dev/staging/prod
- Audit secret access via Cloud Audit Logs

### ❌ DON'T:
- Commit `.env.local` to git
- Hardcode secrets in code or config files
- Share `.env.local` via email or chat
- Use weak or guessable secrets
- Use the same secret across environments

## Checking Environment Variables at Runtime

### In Node.js Code:

```typescript
// Check if running in mock SMS mode
if (process.env.ENABLE_SMS_MOCK === "true") {
  console.log("SMS sending is mocked");
} else {
  // Use real SMS provider (Twilio, SendGrid, etc.)
}

// Access secrets
const firebaseProjectId = process.env.FIREBASE_PROJECT_ID;
const databaseUrl = process.env.DATABASE_URL;
```

### In Cloud Run Logs:

```bash
# View Cloud Run service environment
gcloud run services describe oshi-high-web --region asia-northeast1

# Check logs for secret errors
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=oshi-high-web" --limit 50
```

## Troubleshooting

| Issue | Cause | Solution |
|-------|-------|----------|
| `.env.local not loading` | File not found or misnamed | Run `cp .env.local.example .env.local` |
| `NEXTAUTH_SECRET error` | Secret too short or invalid | Regenerate: `openssl rand -base64 32` |
| `Secret not injected in Cloud Run` | Missing IAM permissions | Grant `secretmanager.secretAccessor` role |
| `SMS not sending (prod)` | ENABLE_SMS_MOCK still true | Verify `--set-env-vars ENABLE_SMS_MOCK=false` |
| `Database connection fails` | Wrong DATABASE_URL | Verify Cloud SQL proxy or connection string |

## References

- [NextAuth.js Configuration](https://next-auth.js.org/getting-started/example)
- [GCP Secret Manager Docs](https://cloud.google.com/secret-manager/docs)
- [Cloud Run Environment Variables](https://cloud.google.com/run/docs/configuring/environment-variables)
- [Cloud SQL Proxy](https://cloud.google.com/sql/docs/postgres/cloud-sql-proxy)
