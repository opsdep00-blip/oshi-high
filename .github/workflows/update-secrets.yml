name: Update GitHub Secrets from Terraform

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  display-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.2

      - name: Configure GCP auth (Staging)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init (Staging)
        run: cd infra/staging && terraform init

      - name: Get Staging Database URL
        id: staging_db_url
        run: |
          cd infra/staging
          DB_URL=$(terraform output -raw database_url 2>/dev/null || echo "ERROR")
          echo "DATABASE_URL for STAGING_DATABASE_URL secret:"
          echo "$DB_URL"
          echo "---"

      - name: Configure GCP auth (Production)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Terraform Init (Production)
        run: cd infra/prod && terraform init

      - name: Get Production Database URL
        id: prod_db_url
        run: |
          cd infra/prod
          DB_URL=$(terraform output -raw database_url 2>/dev/null || echo "ERROR")
          echo "DATABASE_URL for PROD_DATABASE_URL secret:"
          echo "$DB_URL"
          echo "---"
          
      - name: Instructions
        run: |
          echo "✅ Copy the DATABASE_URLs above and update:"
          echo "   1. Settings → Secrets and variables → Actions"
          echo "   2. Update STAGING_DATABASE_URL with the staging value"
          echo "   3. Update PROD_DATABASE_URL with the production value"
          echo ""
          echo "Or run this workflow after Terraform changes to get the latest values."

